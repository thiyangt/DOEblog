---
title: "STA 225 2.0 Design and Analysis of Experiments"
subtitle: "Lecture 11-12"
author: "Dr Thiyanga S. Talagala"
date: "2022-03-08/ 2022-03-25"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: 
      - default
      - default-fonts
      - duke-blue
      - hygge-duke
      - libs/cc-fonts.css
      - libs/figure-captions.css
      - xaringan-themer.css
      - custom.css
    nature:
      ratio: 16:9
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---
```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_duo_accent(
  primary_color = "#081d58",
  secondary_color = "#FF961C",
 inverse_header_color = "#FFFFFF",
 title_slide_text_color = "#edf8b1",
 link_color =  "#41b6c4"
)
#style_solarized_light(text_font_google   = google_font("Josefin Sans", "400", "400i", "800i", "800"))
#style_mono_light(
#  base_color = "#1c5253",
#  header_font_google = google_font("Josefin Sans"),
#  text_font_google   = google_font("Josefin Sans", "400", "400i", "800i", "800"),
#  code_font_google   = google_font("Fira Mono")
#)
```

<style>

.center2 {
  margin: 0;
  position: absolute;
  top: 50%;
  left: 50%;
  -ms-transform: translate(-50%, -50%);
  transform: translate(-50%, -50%);
}

</style>

<style type="text/css">
.remark-slide-content {
    font-size: 27px;
}
</style>
```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE, warnings=FALSE, message=FALSE)
```

## Factorial Design

- CRD, RCBD, LSD: deal with one factor, hence we called them "simple experiments".

- Useful in experimental situations which involve the study of the effect of two or more factors.



- **Factorial**: the effect of several factors are studied simultaneously

- Treatments: All combinations of the different factor levels 

---

## Main effect

- Change in response produced by a change in the level of the factor

.pull-left[
**In-class**

]

.pull-right[

Figure: A factorial experiment without interaction


]

---

## Interaction effect


.pull-left[

**In-class**

]

.pull-right[

Figure: A factorial experiment with interaction


]

---

## The two-factor factorial design

**Life (in hours) Data for the Battery Design Example** (Montgomery, 2004)

```{r, comment=NA, message=FALSE, warning=FALSE}
library(tidyverse)
material_type <- factor(rep(1:3, each=12))
temperature <- factor(rep(c(15, 70, 125), each=4, times = 3))
life <- c(130, 155, 74, 180, 34, 40, 80, 75, 20, 70, 82, 58, 150, 188, 159, 126, 136, 122, 106, 115, 25, 70, 58, 45, 138, 110, 168, 160, 174, 120, 150, 139, 96, 104, 82, 60)
data <- tibble(material = material_type,
               temperature = temperature,
               life = life)
data
```


---

## Data arrangement

In-class


---

# Possible questions

- What effect do material type and temperature have on the life of the battery?

- Robust product design: Is there a choice of material that would give uniformly long life regardless of temperature (material that is not greatly affected by temperature)?

---

## General arrangement for a two-factorial factor design

---

## The effect model

> In class

$$y_{ijk} = \mu + \tau_i + \beta_j + (\tau \beta)_{ij} + \epsilon_{ijk}$$
Introduce all terms and write down the assumptions of the error term
---

## The mean model

> In class

$$y_{ijk} = \mu_{ij} + \epsilon_{ijk}$$
Introduce all terms and write down the assumptions of the error term

---
## Testing hypotheses

1. equality of row treatment effect

H0: $\tau_1=\tau_2=...=\tau_a=0$

H1: at least one $\tau_i \neq 0$

2. equality of column treatment effect

H0: $\beta_1=\beta_2=...=\beta_b=0$

H1: at least one $\beta_i \neq 0$

3. equality of row and column treatments interact

H0: $(\tau\beta)_{ij}=0$ for all $i, j$

H1: at least one $(\tau\beta)_{ij} \neq 0$

---

## Total of observations and grand mean

.pull-left[

### Total

$$y_{...} = \sum_{i=1}^a\sum_{j=1}^b\sum_{k=1}^n y_{ijk}$$

]


.pull-right[

### Mean

$$\bar{y}_{...} = \frac{y_{...}}{abn}$$

]



---

.pull-left[
### Total of observations under the $i$th level of factor A

$$y_{i..}=\sum_{j=1}^b\sum_{k=1}^n y_{ijk}$$


]

.pull-right[

### Mean

$$\bar{y}_{i..} = \frac{y_{i..}}{bn}$$

]

---

.pull-left[
### Total of observations under the $j$th level of factor B

$$y_{.j.}= \sum_{i=1}^a\sum_{k=1}^n y_{ijk}$$


]

.pull-right[

### Mean

$$\bar{y}_{.j.} = \frac{y_{.j.}}{an}$$

]

---

.pull-left[

### Total of all observations in the $ij$th cell

$$y_{ij.}= \sum_{k=1}^n y_{ijk}$$

]


.pull-right[

### Mean

$$\bar{y}_{ij.} = \frac{y_{ij.}}{n}$$

]

---
## Total sum of squares

$$\sum_{i=1}^a\sum_{j=1}^b\sum_{k=1}^n (y_{ijk} - \bar{y}_{...})^2=\sum_{i=1}^a\sum_{j=1}^b\sum_{k=1}^n[(\bar{y}_{i..}-\bar{y}_{...}) + (\bar{y}_{.j.} - \bar{y}_{...}) + (\bar{y}_{ij.} - \bar{y}_{i..} - \bar{y}_{.j.}+\bar{y}_{...}) + (y_{ijk} - \bar{y}_{ij.})]^2$$

Show that

$$SS_T = SS_A + SS_B + SS_{AB} + SS_{E}$$

---

## Degrees of freedom associated with sum of squares

> A : a-1

> B: b-1

> AB interaction: (a-1)(b-1)

> Error: ab(n-1)

> Total: abn-1


---

## ANOVA table

> In class

---
## EDA

.pull-left[

```{r, fig.height=4}
ggplot(data, aes(x=material, y=life, col=material)) + geom_boxplot() + geom_jitter()

```

]

.pull-right[

```{r, fig.height=4}
ggplot(data, aes(x=temperature, y=life, col=temperature)) + geom_boxplot() + geom_jitter()

```

]

---

```{r}
data %>% group_by(temperature) %>%
  summarize(mean = mean(life), sd=sd(life))

data %>% group_by(material) %>%
  summarize(mean = mean(life), sd=sd(life))
```


---
## ANOVA

```{r}
head(data)
fit <- lm(life ~ temperature + material + temperature * material, data=data)
```

---

## ANOVA

```{r}
anova(fit)
```

---
## Manual computation

Total sum of squares

$$SS_T = \sum_{i=1}^{a}\sum_{j=1}^b\sum_{k=1}^ny^2_{ijk} - \frac{y^2_{...}}{abn}$$

Sum of squares for the main effects


$$SS_A = \frac{1}{bn}\sum_{i=1}^{a}y^2_{i..} - \frac{y^2_{...}}{abn}$$

$$SS_B = \frac{1}{an}\sum_{i=1}^{b}y^2_{.j.} - \frac{y^2_{...}}{abn}$$

---

Sum of squares between the *ab* cell totals

$$SS_{Subtotals} = \frac{1}{n}\sum_{i=1}^{a}\sum_{j=1}^by^2_{ij.} - \frac{y^2_{...}}{abn}$$

$$SS_{AB} = SS_{Subtotals} - SS_A - SS_B$$

$$SS_E = SS_T - SS_{Subtotals}$$

---

## Model Adequacy Checking

```{r}
resid_fit <- broom::augment(fit)
resid_fit
```

---

## Assumption

We assume that the error terms $\epsilon_{ijk}$ are normally and independently distributed with constant variance $\sigma^2$.

---

## Normality plot of residuals

.pull-left[
```{r, fig.height=4, fig.width=4}
ggplot(resid_fit, 
       aes(sample=.resid))+
  stat_qq() + stat_qq_line()+labs(x="Theoretical Quantiles", y="Sample Quantiles")

```

]

.pull-right[

```{r}
shapiro.test(resid_fit$.resid)
```

]

---

## Residuals vs Fitted Values

```{r, fig.height=4}
ggplot(resid_fit, aes(x=.fitted, y=.resid)) + geom_point()

```

---

## Plot of residuals vs material type

```{r, fig.height=4}
ggplot(resid_fit, aes(x=material, y=.resid)) + geom_point()

```

---

## Plot of residuals vs temperature

```{r, fig.height=4}
ggplot(resid_fit, aes(x=temperature, y=.resid)) + geom_point()

```

---

## ANOVA table interpretation

```{r}
anovatab <- anova(fit)
anovatab
```

---

### Graph of average responses at each treatment combination

```{r, message=FALSE, warning=FALSE}
average_responses <- data %>% group_by(temperature, material) %>% summarize(mean=mean(life))
average_responses 

```

---

### Graph of average responses at each treatment combination

```{r, message=FALSE, warning=FALSE, fig.height=5}

ggplot(average_responses, aes(x=temperature, y=mean, group=material, col=material)) + geom_point() + geom_path() 

```

---

## Interpretation

> If there is a significant interaction between factor A and factor B

- Omit the tests for main effects when interaction is present.

- Reason: The interaction indicates that the relationship between the levels of factor A vary with the levels of factor B

---

## Interpretation

> If there is no significant interaction

- Then the tests for main effects easily interpreted

- For example we can conclude that there are significant differences between at least two levels of factor A. Further, these differences should be similar at each level of factor B. Then you can use multiple comparisons to determine which levels of factor A are significantly different.

---

## Multiple comparisons: when interaction effect is present

- Perform the multiple comparisons on the "ab" treatments (cell means). 

- Alternatively, a user might want to compare the levels of factor A for a specified levels of factor B


---

## Multiple comparisons

```{r, comment=NA, warning=FALSE}
aov.out <- aov(life ~ material * temperature, data=data)
aov.out

```

---
```{r}
results <- TukeyHSD(aov.out)
results
```


---

```{r}
dim(results$`material:temperature`)
```
---

```{r}

results$`material:temperature`[1:18, ]
```

---

```{r}

results$`material:temperature`[19:30, ]
```

The analysis indicates that **at the temperature level 70** there is no significant difference between the mean battery life for material type 2 and type 3. However, there is a significant difference between mean battery life for material types between 2 and 1. Furthermore, there is a significant difference between mean battery life for material types 3 and 1. Mean battery life for material type 1 is significantly lower in comparison to both material type 2 and 3


---

## Manual calculations

Studentized range statistic

$$q = \frac{\bar{y}_{max}-\bar{y}_{min}}{\sqrt{MS_E/n}}$$

$$T_\alpha = q_\alpha(a, f) \sqrt{\frac{MS_E}{n}}$$
$a$ - treatments

$f$ - number of degrees of freedom associated with $MS_E$

---
Three material (a=3) type at temperature 70

$$T_{0.05} = q_{0.05}(3, 27) \sqrt{\frac{675.21}{4}} = 45.47$$


.pull-left[
$$\bar{y}_{12.} = 57.25$$
$$\bar{y}_{22.} = 119.75$$

$$\bar{y}_{32.} = 145.75$$

]

.pull-right[

**3 vs 1**: $145.75 - 57.25 = 88.50 > T_{0.05}$


**3 vs 2**: $145.75 - 119.75 = 26.00 < T_{0.05}$

**2 vs 1**: $119.75 - 57.25 = 62.50 > T_{0.05}$


]



---

## Acknowledgement

Content is based on "Design and Analysis of Experiments" by Douglas C. Montgomery
